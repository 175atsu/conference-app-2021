package io.github.droidkaigi.confsched2021.news.data

import com.pinterest.ktlint.main
import kotlinx.datetime.Instant
import kotlin.test.Test

class GenerateFakeContents {
    @Test
    fun generate() = runBlocking {
        val newsList = fakeNewsApi()
            .fetch()
            .sortedBy { it.date }
        val code = "" +
            "fun fakeNewsContents(): NewsContents {\n" +
            "    return NewsContents(\n" +
            "        // Generated by GenerateFakeContents.kt\n" +
            "        newsContents = listOf(" + build(newsList) + "),\n" +
            "        favorites = setOf()\n" +
            "    )" +
            "}" +
            ""
        System.setIn(code.byteInputStream())
        main(arrayOf("--stdin", "--experimental", "--android", "-F"))
    }

    private fun build(value: Any): String {
        return when (value) {
            is List<*> -> {
                value.joinToString { build(it!!) }
            }
            is Number -> {
                value.toString()
            }
            is String -> {
                literalize(value)
            }
            is Instant -> {
                "Instant.fromEpochMilliseconds(" + value.toEpochMilliseconds() + ")"
            }
            else -> {
                val kClass = value::class
                val primaryConstructor = kClass.constructors.toList()[0]
                kClass.qualifiedName + "(" +
                    primaryConstructor.parameters.joinToString(",") { parameter ->
                        parameter.name + "=" + build(
                            kClass.members.first { member ->
                                parameter.name == member.name
                            }.call(value)!!
                        )
                    } + ")"
            }
        }
    }

    private fun literalize(value: Any): String {
        val valueString = value.toString()
        if (valueString.lines().size > 1) {
            return "\"\"\"" + valueString + "\"\"\""
        }
        return "\"" + valueString + "\""
    }
}